<!DOCTYPE html>
<html lang="en" xmlns:v-on="http://www.w3.org/1999/xhtml" xmlns:v-band="http://www.w3.org/1999/xhtml"
      xmlns:v-bind="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <link href="static/css/styles.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">

    <link rel="icon" href="static/favicon.ico" type="image/x-icon"/>
    <link rel="shortcut icon" href="static/favicon.ico" type="image/x-icon"/>

    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
    <title>GPA Calculator</title>
</head>
<body>
<div :class="{'mobile' : isMobile}" id="calculator">
    <nav class="navbar">
        <a class="navbar-brand" href="#">GSOM</a>
        <ul class="navbar-nav">
            <li class="nav-item active">
                <a class="nav-link" href="calculator">Калькулятор</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="rating">Рейтинг</a>
            </li>
        </ul>
        <ul class="navbar-right">
            <li class="nav-item">
                <input type="checkbox" class="checkbox" id="mobile" name="mobile" v-model="isMobile">
                <label for="mobile">Mobile</label>
            </li>
        </ul>
    </nav>
    <div class="container-wid">
        <div class="long-content">
            <div class="title block">
                Добро пожаловать. На главной ничего нет, зато есть <a href="calculator">калькулятор</a> среднего балла.
            </div>
            <button id="user-button">None</button>

            <form id="register-form">
                <input name="login" value="admin">
                <input name="password" value="admin">
                <input type="submit" name="submit" value="Register"/>
            </form>
            <form id="login-form">
                <input name="login" value="admin">
                <input name="password" value="admin">
                <input type="submit" name="submit" value="Login"/>
            </form>
            <form id="logout-form">
                <input type="submit" name="submit" value="Logout"/>
            </form>
            <br>
            <form id="request-form">
                <input class="st_login" name="st_login" value="st064362">
                <input class="password" name="password" value="JFHmWFi8">
                <input type="submit" name="submit" value="Get marks"/>
            </form>
        </div>
    </div>
</div>

    <script>
        $.removeCookie = function (key, options) {
            if ($.cookie(key) === undefined) {
                return false;
            }
            // Must not alter options, thus extending a fresh object...
            $.cookie(key, '', $.extend({}, options, {expires: -1}));
            return !$.cookie(key);
        };

        doAjax = function (url, type, data, success) {
            if ($.cookie('token')) {
                data = 'token=' + $.cookie('token') + '&' + data;
            }
            return $.ajax({
                url: url,
                type: type,
                dataType: 'json',
                data: data,
                xhrFields: {withCredentials: true},
                success: success,
            });
        };

        $("#user-button").click(function () {
            doAjax(
                'http://127.0.0.1:5000/user/me',
                'get',
                '',
                function (data) {
                    console.log(data);
                    $("#user-button").html('login' in data ? data['login'] : 'None');
                }
            );
        });

        $("#register-form").submit(function (e) {
            e.preventDefault();

            doAjax(
                'http://127.0.0.1:5000/auth/register',
                'post',
                $("#register-form").serialize(),
                function (data) {
                    console.log(data);
                }
            );
        });

        $("#login-form").submit(function (e) {
            e.preventDefault();

            doAjax(
                'http://127.0.0.1:5000/auth/authorize',
                'post',
                $("#login-form").serialize(),
                function (data) {
                    console.log(data);
                    $.cookie('token', data.token, {path: '/'})
                }
            );
        });

        $("#logout-form").submit(function (e) {
            e.preventDefault();

            doAjax(
                'http://127.0.0.1:5000/auth/logout',
                'post',
                '',
                function (data) {
                    console.log(data);
                    $.cookie('token', '', {path: '/', expires: -1});
                    $.removeCookie('token', {path: '/'})
                }
            );
        });

        $("#request-form").submit(function (e) {
            e.preventDefault();

            doAjax(
                'http://127.0.0.1:5000/marks/load',
                'post',
                $("#request-form").serialize(),
                function (data) {
                    console.log(data);
                }
            );
        });
    </script>
</body>
</html>